<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Browser TTS Bot</title>
  <script src="./tmi.min.js"></script>
  <link rel="stylesheet" href="./index.css" />
</head>

<body>
  <h1>James's TTS Bot</h1>
  <button id="login">Login with Twitch</button>
  <button id="logout" style="display:none;">Logout</button>
  <br />
  <button id="start">Start</button>
  <button id="pause">Stop</button>
  <br />
  <input type="text" id="channel_name" placeholder="channel name" value="FriendJames" />
  <br />

  <div id="status"></div>
  <pre id="log"></pre>

  <script src="./consts.js"></script>
  <script src="./twitch_connection.js"></script>
  <script src="./loader.js"></script>
  <script src="./signup.js"></script>
  <script src="./audio_controls.js"></script>
  <script>
    // ——————————————————————————————————
    // 6) Web Speech API TTS + Recording
    // ——————————————————————————————————
    const synth = window.speechSynthesis;
    const audioCtx = new AudioContext();
    const dest = audioCtx.createMediaStreamDestination();
    const recorder = new MediaRecorder(dest.stream);

    recorder.ondataavailable = e => {
      // Play back the recorded blob so OBS/browser captures it
      const url = URL.createObjectURL(e.data);
      new Audio(url).play();
    };

    // Monkey-patch .speak so we record each utterance
    const origSpeak = synth.speak.bind(synth);
    synth.speak = (utter) => {
      // route speech to our MediaStream
      const source = audioCtx.createMediaStreamSource(dest.stream);
      source.connect(audioCtx.destination);
      if (recorder.state === 'recording') {
        return;
      }
      // Attach event handlers before starting speech
      utter.onend = () => recorder.stop();
      utter.onerror = (e) => recorder.stop();
      recorder.start();
      origSpeak(utter);
    };

    // Simple wrapper to speak text
    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      window.speechSynthesis.speak(u);
    }
  </script>
</body>

</html>
